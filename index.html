<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cálculo Preços de Pizza</title>
</head>

<body>
  <form id="pizzaRegister" action="POST">
    <input id="pizzaName" type="text" required>
    <input id="pizzaSize" min="0" max="100" step="1" type="number" required>
    <input id="pizzaPrice" min="0" step="0.01" type="number" required>
    <button id="addPizza" value="null" type="submit">Adicionar Pizza</button>
  </form>

  <output id="pizzasAdded"></output>

  <button id="comparePizzas" type="button">Comparar Valores</button>

  <table>
    <tr>
      <th>Nome</th>
      <th>Tam.(cm)</th>
      <th>Preço</th>
      <th>R$ p/cm<sup>2</sup></th>
      <th>Diferença%</th>
    </tr>
    <tr>
      <td>Broto</td>
      <td>15</td>
      <td>R$25,00</td>
      <td>R$1,00</td>
      <td>Melhor CB</td>
    </tr>
    <tr>
      <td>Pequena</td>
      <td>25</td>
      <td>R$35,00</td>
      <td>R$1,40</td>
      <td>+40%</td>
    </tr>
    <tr>
      <td>Média</td>
      <td>35</td>
      <td>R$40,00</td>
      <td>R$1,50</td>
      <td>+25%</td>
    </tr>
  </table>


  <script>

    const pizzas = []

    //recebe valores (nome, tamanho e preço das pizzas) e salva na memoria
    document.querySelector('#pizzaRegister').addEventListener('submit', event => {
      event.preventDefault()
      const nodes = Array.from(event.target)
      let pizza = {}
      nodes.forEach(node => {
        if (node.value !== 'null') {
          pizza = {
            ...pizza,
            [node.id]: node.value
          }
        }
      })

      if (checkForDupedName(pizza)) {
        console.log('nome repetido')
        alert('nome repetido')
        return
      } else {
        pizzas.push({
          ...pizza,
          pizzaArea: Math.PI * (pizza.pizzaSize * pizza.pizzaSize),
          pricePerCm2: pizza.pizzaPrice / (Math.PI * (pizza.pizzaSize * pizza.pizzaSize))
        })
      }
      console.log('PIZZAS ::', pizzas)
      document.querySelector('#pizzasAdded').value = `${pizzas.length} pizzas adicionadas`
    })

    //verifica se nome do tamanho de pizza ainda não foi usado
    function checkForDupedName(newPizza) {
      return pizzas.some(({ pizzaName }) => newPizza.pizzaName === pizzaName)
    }

    //verifica a diferença de valor percentual (em relação ao melhor valor)
    function getDiffPercent(bestValue, comparingValue) {
      const diff = ((comparingValue - bestValue) / bestValue) * 100
      return diff < 0 ? (diff * -1) : diff
    }

    //atualiza valores para tela
    document.querySelector('#comparePizzas').addEventListener('click', () => {
      const pizzasSortedByAbsValue = sort(pizzas)
      const bestValue = pizzasSortedByAbsValue[0]
      const tableWithRelPrice = []
      pizzasSortedByAbsValue.forEach((pizza, index) => {
        if (index === 0) {
          tableWithRelPrice.push({
            ...pizza,
            relValue: 'Melhor valor'
          })
        } else {
          tableWithRelPrice.push({
            ...pizza,
            relValue: getDiffPercent(bestValue.pricePerCm2, pizza.pricePerCm2)
          })
        }
      })

      console.table(tableWithRelPrice)
    })

    //ordena array de pizzas pelo menor valor (preco/cm2)
    function sort(arr) {
      const size = arr.length
      let itemTrocado
      do {
        itemTrocado = false
        for (let i = 0; i < size - 1; i++) {
          if (arr[i].pricePerCm2 > arr[i + 1].pricePerCm2) {
            const temp = arr[i]
            arr[i] = arr[i + 1]
            arr[i + 1] = temp
            itemTrocado = true
          }
        }
      } while (itemTrocado)

      return arr
    }
  </script>
</body>

</html>